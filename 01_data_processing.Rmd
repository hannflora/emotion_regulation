---
title: "01_data_processing"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

# loading packages
```{r}

suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(sjPlot))
suppressPackageStartupMessages(library(lme4))
suppressPackageStartupMessages(library(psych))
suppressPackageStartupMessages(library(lavaan))
suppressPackageStartupMessages(library(semTools))
suppressPackageStartupMessages(library(semPlot))
suppressPackageStartupMessages(library(ltm))

```


# reading dataset
```{r}
dat_cleaned <- read_csv("data/data_cleaned.csv")
```


# reordering and renaming variables
```{r}
# reordering variables
dat_cleaned <- dat_cleaned %>% 
  dplyr::select(id = id_emo, day, beep, age, gender, edu, date_emotics, date_diary, diary_counter,
         sad:subc_psycho, cheerful = cheerfull, irritated:event_pleasantness, #esm
         cerq1:cerq36, sb_cerq:ob_cerq, # cross-sectional
         anxiety_1, anxiety_2, anxiety_3, anxiety_4, anxiety_5, depression_1:depression_3, depression_4, depression_5, depression_6:depression_10, depression_11:extra_neg_event)

# renaming variables for consistency
dat_cleaned <- dat_cleaned %>% 
  rename_at(vars(starts_with("cerq")), funs(str_replace(., "cerq", "cerq_")))
```


# filling missing values in cross-sectional variables
```{r}
dat_cleaned <- dat_cleaned %>%
  group_by(id) %>% 
  fill(c(sb_cerq:ob_cerq), .direction = "updown") %>% 
  ungroup()
```


# filtering obeservations with missing ESM
```{r}
dat_cleaned <- dat_cleaned %>% 
  filter(!is.na(date_emotics))
```


# parallel analysis of affective states
```{r}
prin <- 
  dat_cleaned %>%
  dplyr::select(sad, calm, afraid, unrested, enthusiastic, angry, worried, cheerful, irritated, active)

(parallel <- fa.parallel(prin, fm = "pa"))

(principal <- 
    psych::principal(prin, nfactors = 2, rotate = "oblimin"))

# binding component scores to dataset
dat_cleaned <- 
  dat_cleaned %>%
  cbind(as.data.frame(principal$scores)) %>%
  mutate(negaff = TC1,
         posaff = TC2) %>% 
  dplyr::select(-TC1, -TC2)
```


# centering metrics within- and between individuals
```{r}
# reversing event pleasantness to event unpleasantness
dat_cleaned <-
  dat_cleaned %>% 
  mutate(event_unpleasantness = 8-event_pleasantness) %>% 
  dplyr::select(-event_pleasantness)


# within-person centering of NA and event unpleasantness
dat_cleaned <-
  dat_cleaned %>% 
  group_by(id) %>%
  mutate_at(vars(negaff, posaff, event_unpleasantness),
            .funs = list(centered = ~ scale(., scale = F, center = T))) %>% 
  distinct()


# between-level means
dat_cleaned <-
  dat_cleaned %>%
  group_by(id) %>%
  mutate_at(vars(negaff,
                 posaff,
                 event_unpleasantness),
            .funs = list(mean = ~ mean(., na.rm = T))) %>%
  ungroup()

# grand-mean centering
dat_cleaned <- dat_cleaned %>%
  mutate(negaff_mean_grand_centered = scale(negaff_mean, center = T, scale = F))
```

# CFA for rumination

```{r}

dat_cfa_rum <- 
  dat_cleaned %>% 
  dplyr::select(id, cerq_1, cerq_9, cerq_19, cerq_29) %>%
  distinct()
  

cfa_rum <- 'rumination =~ cerq_1 + cerq_9 + cerq_19 + cerq_29'



fit_rumi <- cfa(model = cfa_rum, data = dat_cfa_rum, std.lv = TRUE, estimator = "ML")
  

```

```{r}
fitMeasures(fit_rumi, c("chisq", "df", "pvalue", "cfi", "tli",
                   "rmsea", "srmr"))
```

```{r}
summary(fit_rumi, fit.measures = TRUE, standardize = TRUE)
```

```{r}
# reliability of rimination factor (omega)
(reliability(fit_rumi))
```

```{r}

# add rumination between-subject factor scores to the main dataset

scores_cfa_rumination <-
  dat_cfa_rum %>%
  distinct() %>%
  cbind(lavPredict(fit_rumi, newdata = dat_cfa_rum[1:5]))

dat_cleaned <-
  dat_cleaned %>%
  left_join(scores_cfa_rumination, by = c("id"))

```

# multilevel CFA for negative affective states
```{r, warning = F}

cfa_aff <-
  dat_cleaned %>%
  filter(!is.na(date_emotics)) %>%
  dplyr::select(id, date_emotics, beep, sad, afraid, unrested, irritated, angry) %>%
  filter_at(vars(sad:angry), all_vars(!is.na(.))) %>%
  distinct() %>%
  ungroup()

cfa_aff_syntax <- '

  level: 1

      NA_within =~ sad + afraid + unrested + angry
      afraid ~~ angry

  level: 2

      NA_between =~ sad + afraid + unrested + angry
'
# "irritated" has been omitted from the analysis since it worsened the fit of the model

fit <- cfa(model = cfa_aff_syntax, data = cfa_aff, cluster = "id", std.lv = TRUE, estimator = "ML")
```

```{r}
fitMeasures(fit, c("chisq", "df", "pvalue", "cfi", "tli",
                   "rmsea", "srmr_within", "srmr_between"))
```

```{r}
summary(fit, fit.measures = TRUE, standardize = TRUE)
```

```{r}
modificationindices(fit) %>%
  dplyr::select("lhs", "op", "rhs", "level", "mi") %>%
  arrange(desc(mi)) %>%
  # filter(level == 1) %>% 
  head(n = 10) %>%
  print()
```

```{r}
# within-person factor loadings
(inspect(fit, what = "std")$within$lambda)

# between-person factor loadings
(inspect(fit, what = "std")$id$lambda)

# reliability of NA model
(reliability(fit))
```

```{r}

# between subject factor score-okat hozz√°adni a within subject-ekhez

dat_cfa_lev_2 <-
  cfa_aff %>%
  dplyr::select(id) %>%
  distinct() %>%
  cbind(lavPredict(fit, newdata = cfa_aff[4:8], level = 2L))

dat_cfa_lev_1 <-
  cfa_aff %>%
  cbind(lavPredict(fit, newdata = cfa_aff[4:8], level = 1L)) %>%
  dplyr::select(-c(sad:angry))

dat_cfa <-
  dat_cfa_lev_1 %>%
  left_join(dat_cfa_lev_2, by = "id") %>%
  mutate(NA_sum =  NA_within + NA_between)

dat_cleaned <-
  dat_cleaned %>%
  left_join(dat_cfa, by = c("id", "date_emotics", "beep"))

```


# reliability of CERQ rumination scale
```{r}
dat_cleaned_cerq <- dat_cleaned %>%  
  dplyr::select(cerq_3, cerq_12, cerq_21, cerq_30) %>% 
  distinct()

cronbach.alpha(dat_cleaned_cerq)
```


# selecting model-relevant variables
```{r}
# dat_model <- dat_cleaned %>% 
#   select()
  
```


# writing dat_cleaned into .csv file
```{r}
# dat_cleaned %>% 
#   write.csv("data/data_processed.csv", row.names = F)
```

